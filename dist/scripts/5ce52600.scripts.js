"use strict";function compareJSO(a,b){var c=Object.getOwnPropertyNames(a),d=Object.getOwnPropertyNames(b);if(c.length!=d.length)return!1;for(var e=0;e<c.length;e++){var f=c[e];if(a[f]!==b[f])return!1}return!0}angular.module("graphApp",[]),angular.module("graphApp").controller("graphController",["$scope","fileReader","xmlWorkflowParser",function(a,b,c){function d(b){var c=JSON.parse(b);a.graphData.nodes=c.nodes,a.graphData.links=c.links}function e(a){var b=a.split(".");return b[b.length-1]}a.showDialog=!1,a.selectedNodeIndex=0,a.workflowText="when you upload a workflow, the file contents will display here",a.graphData={nodes:[{name:1},{name:2},{name:3},{name:4},{name:5},{name:6}],links:[{source:0,target:1,condition:"Ω"},{source:1,target:2,condition:"ß"},{source:2,target:3,condition:"π"}]},a.screen=1,a.showNodeDialog=function(b){for(var c=a.graphData.nodes,d=0;c>d;d++)if(compareJSO(n,b)){a.selectedNodeIndex=d;break}a.showDialog=!0},a.hideNodeDialog=function(){a.showDialog=!1},a.getFile=function(f){a.progress=0,b.readFileAsText(f,a).then(function(b){a.workflowText=b;var g=e(f.name);g&&"json"===g?(d(b),a.restartGraph()):g&&"xml"===g&&(c.parseUsingXML(b,a).then(function(){}),a.restartGraph())})},a.$on("fileProgress",function(b,c){a.progress=c.loaded/c.total})}]),angular.module("graphApp").directive("workflowGraph",[function(){return{restrict:"E",link:function(a,b){function c(a){var b=.1*a.alpha;k.nodes().forEach(function(a){var c=a.type||"none set";"step"===c?(a.y+=(i.y-a.y)*b,a.x+=(i.x-a.x)*b):"def"===c&&(a.y+=(j.y-a.y)*b,a.x+=(j.x-a.x)*b)}),n.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),p.attr("transform",function(a){var b=a.source.x,c=a.source.y,d=a.target.x,e=a.target.y;return"translate("+(b+d)/2+","+(c+e)/2+")"}),m.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),o.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}function d(b){d3.event.defaultPrevented||a.$apply(function(){a.showNodeDialog(b)})}function e(a){a.origSize=d3.select(this).attr("r");var b=1.5*a.origSize;d3.select(this).attr("r",b)}function f(a){d3.select(this).attr("r",a.origSize).select("text.hoverText").remove()}var g=1e3,h=600,i={x:g/4,y:h/4},j={x:3*g/4,y:3*h/4},k=d3.layout.force().friction(.7).charge(-1e3).linkDistance(200).size([g,h]).on("tick",c),l=d3.select(b[0]).append("svg").attr("width",g).attr("height",h),m=l.selectAll(".node"),n=l.selectAll(".link"),o=l.selectAll(".nodeLabel"),p=l.selectAll(".linkLabel");a.restartGraph=function(b,c){k.nodes(b?b:a.graphData.nodes),k.links(c?c:a.graphData.links),m=m.data(k.nodes(),function(a){return a.name+""+a.content}),o=o.data(k.nodes(),function(a){return a.name+""+a.content}),n=n.data(k.links(),function(a){return a.source+""+a.target+a.condition}),p=p.data(k.links(),function(a){return a.source+""+a.target+a.condition}),n.enter().insert("line",".node").attr("class","link"),p.enter().append("text").attr("class","linkLabel").attr("dx",5).attr("dy",".1em").text(function(a){return a.condition||""}),m.enter().insert("circle").attr("class",function(a){return a.initial===!0?"node step initial":"def"===a.type?"node def":"step"===a.type?"node step":void 0}).attr("r",10).call(k.drag),o.enter().append("text").attr("class","nodeLabel").attr("dx",12).attr("dy",".35em").text(function(a){return a.name||"no name"}),p.exit().remove(),n.exit().remove(),o.exit().remove(),m.exit().remove(),m.on("click",d),m.on("mouseover",e),m.on("mouseout",f),k.start()},a.restartGraph(),a.resetGraph=function(){a.restartGraph([],[])}}}}]),angular.module("graphApp").directive("modalDialog",function(){return{restrict:"E",replace:!0,transclude:!0,link:function(a,b,c){a.modalStyle={},c.width&&(a.modalStyle.width=c.width),c.height&&(a.modalStyle.height=c.height),a.hideModal=function(){a.showDialog=!1}},template:"<div class='ng-modal'> <div class='ng-modal-overlay' ng-click='hideModal()'></div><div class='ng-modal-dialog' ng-style='modalStyle'><div class='ng-modal-close' ng-click='hideModal()'>X</div><div class='ng-modal-dialog-content' ng-transclude></div></div></div>"}}),angular.module("graphApp").directive("myFileSelect",[function(){return{link:function(a,b){b.bind("change",function(b){var c=(b.srcElement||b.target).files[0];a.getFile(c)})}}}]),angular.module("graphApp").factory("fileReader",["$q",function(a){var b=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},c=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},d=function(a,b){return function(a){b.$broadcast("fileProgress",{total:a.total,loaded:a.loaded})}},e=function(a,e){var f=new FileReader;return f.onload=b(f,a,e),f.onerror=c(f,a,e),f.onprogress=d(f,e),f},f=function(b,c){var d=a.defer(),f=e(d,c);return f.readAsDataURL(b),d.promise},g=function(b,c){var d=a.defer(),f=e(d,c);return f.readAsText(b),d.promise};return{readFileAsUrl:f,readFileAsText:g}}]),angular.module("graphApp").factory("xmlWorkflowParser",["$q",function(a){function b(a,b,k){k.graphData={nodes:[],links:[]};var l=new DOMParser,m=l.parseFromString(b,"text/xml"),n=m.documentElement,o=n.childNodes,p=h(n,"initialStepName")[0];e(p.textContent,k);for(var q=m.getElementsByTagName("contextDataDef"),r=0;r<q.length;r++){var s=q.item(r),t=d(s);alert("data def: "+JSON.stringify(t)),f(t,k)}for(var r=0;r<o.length;r++){var u=o.item(r);if(!u.nodeName.match(/^#/)){var v=d(u);alert("step obj: "+JSON.stringify(v));var w=h(u,"transition");w.forEach(function(a){var b=a.getAttribute("condition"),d=h(a,"targetStepName")[0],e=d.textContent,f=c(e,k);alert("tafet obj: "+JSON.stringify(f));var l=g(v,k),m=j(f,k);i(l,m,b,k)})}}a.resolve("success")}function c(a,b){var c=b.graphData.nodes;c.forEach(function(b){return b.name==a,b})}function d(a){for(var b=a.attributes,c={},d=0;d<b.length;d++)c[b[d].name]=b[d].value;return c}function e(a,b){var c=g({name:a},b);b.graphData.nodes[c].initial=!0}function f(a){return j({name:a.name||"no name",dataType:a.dataType||"no data type",defaultDataExpression:a.defaultDataExpression||"no default data expression",type:"def"})}function g(a,b){return j({name:a.name||"no name",executionLabelExpression:a.executionLabelExpression||"no execution label expression",mediaConversionTemplateExpression:a.mediaConversionTemplateExpression||"no media conversion template expression",targetContentTemplateExpression:a.targetContentTemplateExpression||"no target content tempalte expression",sourceFileExpression:a.sourceFileExpression||"no source file expression",pctComplete:a.pctComplete||"no pct complete",resultDataDef:a.resultDataDef||"no result data def",subjectChangePath:a.subjectChangePath||"no subject change path",targetWorkflowId:a.targetWorkflowId||"no target workflow id",type:"step"},b)}function h(a,b){for(var c=[],d=a.childNodes,e=0;e<d.length;e++){var f=d.item(e);f.nodeName===b&&c.push(f)}return c}function i(a,b,c,d){d.graphData.links.push({source:a,target:b,condition:c})}function j(a,b){for(var c=b.graphData.nodes,d=0;d<c.length;d++)if(c[d].name==a.name)return c[d]=a,d;return c.push(a),c.length-1}function k(a){var b=new DOMParser,a=b.parseFromString(a,"text/xml");return l(a)}function l(a){{var b=new XMLSerializer,c=a.documentElement;c.childNodes,c.attributes}alert(b.serializeToString(c))}var m=function(c,d){var e=a.defer();return b(e,c,d),e.promise};return{parseUsingXML:m,listifyXMLElement:l,listifyXMLTest:k}}]);