"use strict";angular.module("graphApp",[]),angular.module("graphApp").controller("graphController",["$scope","fileReader","xmlWorkflowParser",function(a,b,c){function d(b){var c=JSON.parse(b);a.graphData.nodes=c.nodes,a.graphData.links=c.links}function e(a){var b=a.split(".");return b[b.length-1]}a.dialogText="not set",a.graphData={nodes:[{name:1},{name:2},{name:3},{name:4},{name:5},{name:6}],links:[{source:0,target:1},{source:1,target:2},{source:2,target:3}]},a.showDialog=!1,a.screen=1,a.workflowText=JSON.stringify(a.graphData),a.showNodeDialog=function(b){a.dialogText=b&&b.content?b.content:"no content",a.showDialog=!0},a.hideNodeDialog=function(){a.showDialog=!1},a.getFile=function(f){a.progress=0,b.readFileAsText(f,a).then(function(b){a.workflowText=b;var g=e(f.name);g&&"json"===g?(d(b),a.restartGraph()):g&&"xml"===g&&(c.parseUsingXML(b,a).then(function(a){console.log(a)}),a.restartGraph())})},a.$on("fileProgress",function(b,c){a.progress=c.loaded/c.total})}]),angular.module("graphApp").directive("workflowGraph",[function(){return{restrict:"E",link:function(a,b){function c(a){var b=.1*a.alpha;k.nodes().forEach(function(a){var c=a.type||"none set";"step"===c?(a.y+=(i.y-a.y)*b,a.x+=(i.x-a.x)*b):"def"===c&&(a.y+=(j.y-a.y)*b,a.x+=(j.x-a.x)*b)}),n.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),p.attr("transform",function(a){var b=a.source.x,c=a.source.y,d=a.target.x,e=a.target.y;return"translate("+(b+d)/2+","+(c+e)/2+")"}),m.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),o.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}function d(b){d3.event.defaultPrevented||a.$apply(function(){a.showNodeDialog(b)})}function e(a){a.origSize=d3.select(this).attr("r");var b=1.5*a.origSize;d3.select(this).attr("r",b)}function f(a){d3.select(this).attr("r",a.origSize).select("text.hoverText").remove()}var g=1e3,h=480,i={x:g/4,y:h/4},j={x:3*g/4,y:3*h/4},k=d3.layout.force().friction(.7).charge(-1e3).linkDistance(200).size([g,h]).on("tick",c),l=d3.select(b[0]).append("svg").attr("width",g).attr("height",h),m=l.selectAll(".node"),n=l.selectAll(".link"),o=l.selectAll(".nodeLabel"),p=l.selectAll(".linkLabel");a.restartGraph=function(b,c){k.nodes(b?b:a.graphData.nodes),k.links(c?c:a.graphData.links),m=m.data(k.nodes(),function(a){return a.name+""+a.content}),o=o.data(k.nodes(),function(a){return a.name+""+a.content}),n=n.data(k.links(),function(a){return a.source+""+a.target+a.condition}),p=p.data(k.links(),function(a){return a.source+""+a.target+a.condition}),n.enter().insert("line",".node").attr("class","link"),p.enter().append("text").attr("class","linkLabel").attr("dx",5).attr("dy",".1em").text(function(a){return a.condition||""}),m.enter().insert("circle").attr("class",function(a){return a.initial===!0?"node step initial":"def"===a.type?"node def":"step"===a.type?"node step":void 0}).attr("r",10).call(k.drag),o.enter().append("text").attr("class","nodeLabel").attr("dx",12).attr("dy",".35em").text(function(a){return a.name||"no name"}),p.exit().remove(),n.exit().remove(),o.exit().remove(),m.exit().remove(),m.on("click",d),m.on("mouseover",e),m.on("mouseout",f),k.start()},a.restartGraph(),a.resetGraph=function(){a.restartGraph([],[])}}}}]),angular.module("graphApp").directive("modalDialog",function(){return{restrict:"E",replace:!0,transclude:!0,link:function(a,b,c){a.dialogStyle={},c.width&&(a.dialogStyle.width=c.width),c.height&&(a.dialogStyle.height=c.height),a.hideModal=function(){a.showDialog=!1}},template:"<div class='ng-modal'> <div class='ng-modal-overlay' ng-click='hideModal()'></div><div class='ng-modal-dialog' ng-style='dialogStyle'><div class='ng-modal-close' ng-click='hideModal()'>X</div><div class='ng-modal-dialog-content' ng-transclude></div></div></div>"}}),angular.module("graphApp").directive("myFileSelect",[function(){return{link:function(a,b){b.bind("change",function(b){var c=(b.srcElement||b.target).files[0];a.getFile(c)})}}}]),angular.module("graphApp").factory("fileReader",["$q",function(a){var b=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},c=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},d=function(a,b){return function(a){b.$broadcast("fileProgress",{total:a.total,loaded:a.loaded})}},e=function(a,e){var f=new FileReader;return f.onload=b(f,a,e),f.onerror=c(f,a,e),f.onprogress=d(f,e),f},f=function(b,c){var d=a.defer(),f=e(d,c);return f.readAsDataURL(b),d.promise},g=function(b,c){var d=a.defer(),f=e(d,c);return f.readAsText(b),d.promise};return{readFileAsUrl:f,readFileAsText:g}}]),angular.module("graphApp").factory("xmlWorkflowParser",["$q",function(a){function b(a,b,i){i.graphData={nodes:[],links:[]};var j=new XMLSerializer,k=new DOMParser,l=k.parseFromString(b,"text/xml"),m=l.documentElement,n=m.childNodes,o=f(m,"initialStepName")[0];c(o.textContent,j.serializeToString(o),i);for(var p=l.getElementsByTagName("contextDataDef"),q=0;q<p.length;q++){var r=p.item(q),s=r.getAttribute("name");d(s,j.serializeToString(r),i)}for(var q=0;q<n.length;q++){var t=n.item(q);if(!t.nodeName.match(/^#/)){var u=t.getAttribute("name"),v=f(t,"transition");v.length>0&&v.forEach(function(a){var b=a.getAttribute("condition"),c=f(a,"targetStepName")[0],d=c.textContent,k=e(n,u),l=h(u,j.serializeToString(k),i),m=e(n,d),o=h(d,j.serializeToString(m),i);g(l,o,b,i)})}}}function c(a,b,c){var d=h(a,b,c);c.graphData.nodes[d].initial=!0}function d(a,b,c){c.graphData.nodes.push({name:a,content:b,type:"def"})}function e(a,b){for(var c=0;c<a.length;c++){var d=a.item(c);if(d.attributes&&d.getAttribute("name")===b)return d}return null}function f(a,b){for(var c=[],d=a.childNodes,e=0;e<d.length;e++){var f=d.item(e);f.nodeName===b&&c.push(f)}return c}function g(a,b,c,d){d.graphData.links.push({source:a,target:b,condition:c})}function h(a,b,c){for(var d=-1,e=c.graphData.nodes,f=0;f<e.length;f++)e[f].name===a&&(d=f);return d>-1?d:(e.push({name:a,content:b,type:"step"}),e.length-1)}var i=function(c,d){var e=a.defer();return b(e,c,d),e.promise},j=function(){var b=a.defer();return b.promise};return{parseUsingJSON:j,parseUsingXML:i}}]);